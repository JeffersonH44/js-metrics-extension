{"version":3,"sources":["webpack:///bubblemap.js","webpack:///webpack/bootstrap b5e5e27b81f1b74b35c5","webpack:///./src/index.js","webpack:///./src/component.js","webpack:///./src/template.html"],"names":["modules","__webpack_require__","moduleId","installedModules","exports","module","i","l","call","m","c","value","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","_component","_component2","obj","default","VERSION_INFO","version","build","BubbleMap","Vizabi","Tool","extend","init","placeholder","external_model","this","components","component","model","Component","_super","default_model","state","time","delay","delayThresholdX2","delayThresholdX4","entities","opacitySelectDim","opacityRegular","locale","ui","map","path","colorGeo","preserveAspectRatio","scale","offset","top","right","bottom","left","projection","topology","objects","geo","boundaries","geoIdProperty","chart","superhighlightOnMinimapHover","labels","dragging","datawarning","doubtDomain","doubtRange","buttons","dialogs","popup","sidebar","moreoptions","presentation","versionInfo","_defineProperty","key","writable","_Vizabi","utils","_globals","_Vizabi$helpers","helpers","Labels","topojson","d3GeoProjection","DynamicBackground","_Vizabi$iconset","iconset","iconWarn","warn","iconQuestion","question","BubbleMapComponent","config","context","_this2","template","bubblesDrawing","isMobile","isMobileOrTablet","model_expects","type","_this","model_binds","change:time.value","evt","_readyOnce","marker","getFrame","frameChanged","bind","change:marker.highlight","highlightMarkers","updateOpacity","change:marker","indexOf","ready","change:marker.size.extent","entityBubbles","updateMarkerSizeLimits","redrawDataPoints","change:marker.color.palette","change:marker.select","selectMarkers","updateDoubtOpacity","change:marker.opacitySelectDim","change:marker.opacityRegular","change:marker.superHighlight","_blinkSuperHighlighted","sScale","cScale","d3","scaleOrdinal","schemeCategory10","COLOR_WHITEISH","_labels","CSS_PREFIX","LABELS_CONTAINER_CLASS","LINES_CONTAINER_CLASS","SUPPRESS_HIGHLIGHT_DURING_PLAY","readyOnce","element","select","graph","mapSvg","bubbleContainerCrop","bubbleContainer","labelListContainer","dataWarningEl","yTitleEl","cTitleEl","yInfoEl","cInfoEl","yearEl","year","setConditions","xAlign","yAlign","on","updateSize","initMap","KEY","getDimension","TIMEDIM","updateUIStrings","wScale","scaleLinear","domain","range","updateIndicators","values","toString","defer","updateEntities","updateTime","frame","translator","getTFunction","conceptPropsS","size","getConceptprops","conceptPropsC","color","strings","title","S","C","text","parent","findChildByName","markerID","alignX","isRTL","alignY","updateView","toggle","setIcon","attr","append","html","style","Number","Boolean","description","sourceLink","pin","rect","getBBox","coord","makeAbsoluteContext","farthestViewportElement","x","y","height","toolRect","root","getBoundingClientRect","chartRect","node","setHook","show","setPos","hide","updateTitleNumbers","mobile","length","hovered","formatterS","getTickFormatter","formatterC","unitS","unit","unitC","valueS","valueC","isDiscrete","getColorlegendMarker","label","getItems","classed","opacity","getUTCFullYear","someSelected","OPACITY_REGULAR","OPACITY_SELECT_DIM","someHighlighted","isHighlighted","isSelected","nonSelectedOpacityZero","getScale","getKeys","prefix","pointer","endTime","sortValue","sort","a","b","end","setVisible","splash","unselectBubblesWithNoData","selectAll","data","getVisible","order","exit","remove","enter","isTouchDevice","_interact","_mouseover","_mouseout","_click","onTap","event","stopPropagation","onLongTap","merge","forEach","selectMarker","duration","reposition","each","index","view","valueX","hook_lng","valueY","hook_lat","valueL","hidden_1","hidden","transition","ease","easeLinear","_updateLabel","r","areaToRadius","cLoc","skew","interrupt","time_1","playing","delayAnimations","setText","formatDate","fitSizeOfTitles","yTitleText","cTitleText","yTitleBB","cTitleBB","font","Math","max","parseInt","width","_this3","capitalize","mapPath","geoPath","mapGraph","mapFeature","feature","mesh","translate","mapBounds","bounds","features","insert","properties","toLowerCase","datum","profiles","small","margin","infoElHeight","minRadiusPx","maxRadiusEm","medium","large","presentationProfileChanges","activeProfile","getActiveProfile","containerWH","getVizWidthHeight","maxRadiusPx","hypotenuse","repositionElements","rescaleMap","widthRatio","resize","getLayoutProfile","use","warnBB","titleBBox","t","transform","hTranslate","translateX","translateY","mapWidth","mapHeight","viewPortHeight","viewPortWidth","mapTopOffset","mapLeftOffset","widthScale","heightScale","viewBoxHeight","viewBoxWidth","join","w","h","points","extent","minRadius","maxRadius","minArea","radiusToArea","maxArea","concat","highlightMarker","_setTooltip","clearHighlighted","_this4","isSuperHighlighted","highlight","druging","showhide","cache","labelX0","labelY0","scaledS0","scaledC0","updateLabel","showCloseCross","labelValues","tooltipCache","mouse","labelText","setTooltip","preload","_this5","loadFromFile","assetName","onSuccess","getAsset","response","topoPath","getProp","topoWhich","topoKey","Promise","resolve","reject","dim","query","language","id","from","where","$and","$in","dataPromise","load","then","dataId","getData","err","JSON","stringify"],"mappings":"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","file":"bubblemap.js","sourcesContent":["/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// identity function for calling harmony imports with the correct context\n/******/ \t__webpack_require__.i = function(value) { return value; };\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, {\n/******/ \t\t\t\tconfigurable: false,\n/******/ \t\t\t\tenumerable: true,\n/******/ \t\t\t\tget: getter\n/******/ \t\t\t});\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module['default']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, 'a', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = 4);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\n__webpack_require__(2);\n\nvar _component = __webpack_require__(1);\n\nvar _component2 = _interopRequireDefault(_component);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar VERSION_INFO = { version: \"1.0.16\", build: 1507740295509 };\n\n//BAR CHART TOOL\nvar BubbleMap = Vizabi.Tool.extend(\"BubbleMap\", {\n\n  /**\n   * Initializes the tool (Bar Chart Tool).\n   * Executed once before any template is rendered.\n   * @param {Object} placeholder Placeholder element for the tool\n   * @param {Object} external_model Model as given by the external page\n   */\n  init: function init(placeholder, external_model) {\n\n    this.name = \"bubblemap\";\n\n    //specifying components\n    this.components = [{\n      component: _component2.default,\n      placeholder: \".vzb-tool-viz\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"locale\", \"ui\", \"data\"] //pass models to component\n    }, {\n      component: Vizabi.Component.get(\"timeslider\"),\n      placeholder: \".vzb-tool-timeslider\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"ui\"]\n    }, {\n      component: Vizabi.Component.get(\"dialogs\"),\n      placeholder: \".vzb-tool-dialogs\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"buttonlist\"),\n      placeholder: \".vzb-tool-buttonlist\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"treemenu\"),\n      placeholder: \".vzb-tool-treemenu\",\n      model: [\"state.marker\", \"state.marker_tags\", \"state.time\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datawarning\"),\n      placeholder: \".vzb-tool-datawarning\",\n      model: [\"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datanotes\"),\n      placeholder: \".vzb-tool-datanotes\",\n      model: [\"state.marker\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"steppedspeedslider\"),\n      placeholder: \".vzb-tool-stepped-speed-slider\",\n      model: [\"state.time\", \"locale\"]\n    }];\n\n    //constructor is the same as any tool\n    this._super(placeholder, external_model);\n  },\n\n\n  default_model: {\n    state: {\n      time: {\n        \"delay\": 100,\n        \"delayThresholdX2\": 50,\n        \"delayThresholdX4\": 25\n      },\n      entities: {\n        \"opacitySelectDim\": 0.3,\n        \"opacityRegular\": 1\n      }\n    },\n    locale: {},\n    ui: {\n      map: {\n        path: null,\n        colorGeo: false,\n        preserveAspectRatio: true,\n        scale: 0.95,\n        offset: {\n          top: 0,\n          right: 0,\n          bottom: 0,\n          left: 0\n        },\n        projection: \"robinson\",\n        topology: {\n          path: null,\n          objects: {\n            geo: \"land\",\n            boundaries: \"countries\"\n          },\n          geoIdProperty: null\n        }\n      },\n      chart: {\n        superhighlightOnMinimapHover: true,\n        labels: {\n          dragging: true\n        }\n      },\n      datawarning: {\n        doubtDomain: [],\n        doubtRange: []\n      },\n      \"buttons\": [\"colors\", \"find\", \"size\", \"moreoptions\", \"fullscreen\", \"presentation\"],\n      \"dialogs\": {\n        \"popup\": [\"colors\", \"find\", \"size\", \"moreoptions\"],\n        \"sidebar\": [\"colors\", \"find\", \"size\"],\n        \"moreoptions\": [\"opacity\", \"speed\", \"size\", \"colors\", \"presentation\", \"about\"]\n      },\n      presentation: false\n    }\n  },\n\n  versionInfo: VERSION_INFO\n});\n\nexports.default = BubbleMap;\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nvar _Vizabi = Vizabi,\n    globals = _Vizabi._globals,\n    utils = _Vizabi.utils,\n    Component = _Vizabi.Component,\n    _Vizabi$helpers = _Vizabi.helpers,\n    Labels = _Vizabi$helpers.labels,\n    topojson = _Vizabi$helpers.topojson,\n    d3GeoProjection = _Vizabi$helpers[\"d3.geoProjection\"],\n    DynamicBackground = _Vizabi$helpers[\"d3.dynamicBackground\"],\n    _Vizabi$iconset = _Vizabi.iconset,\n    iconWarn = _Vizabi$iconset.warn,\n    iconQuestion = _Vizabi$iconset.question;\n\n// BUBBLE MAP CHART COMPONENT\n\nvar BubbleMapComponent = Component.extend(\"bubblemap\", {\n  /**\n   * Initializes the component (Bubble Map Chart).\n   * Executed once before any template is rendered.\n   * @param {Object} config The config passed to the component\n   * @param {Object} context The component's parent\n   */\n  init: function init(config, context) {\n    var _this2 = this;\n\n    this.name = \"bubblemap\";\n    this.template = __webpack_require__(3);\n    this.bubblesDrawing = null;\n\n    this.isMobile = utils.isMobileOrTablet();\n\n    //define expected models for this component\n    this.model_expects = [{\n      name: \"time\",\n      type: \"time\"\n    }, {\n      name: \"entities\",\n      type: \"entities\"\n    }, {\n      name: \"marker\",\n      type: \"marker\"\n    }, {\n      name: \"locale\",\n      type: \"locale\"\n    }, {\n      name: \"ui\",\n      type: \"ui\"\n    }, {\n      name: \"data\",\n      type: \"data\"\n    }];\n\n    var _this = this;\n    this.model_binds = {\n      \"change:time.value\": function changeTimeValue(evt) {\n        if (!_this._readyOnce) return;\n        _this.model.marker.getFrame(_this.model.time.value, _this.frameChanged.bind(_this));\n      },\n      \"change:marker.highlight\": function changeMarkerHighlight(evt) {\n        if (!_this._readyOnce) return;\n        _this.highlightMarkers();\n        _this.updateOpacity();\n      },\n      \"change:marker\": function changeMarker(evt, path) {\n        // bubble size change is processed separately\n        if (!_this._readyOnce) return;\n\n        if (path.indexOf(\"scaleType\") > -1) {\n          _this.ready();\n        }\n      },\n      \"change:marker.size.extent\": function changeMarkerSizeExtent(evt, path) {\n        //console.log(\"EVENT change:marker:size:max\");\n        if (!_this._readyOnce || !_this.entityBubbles) return;\n        _this.updateMarkerSizeLimits();\n        _this.redrawDataPoints(null, false);\n      },\n      \"change:marker.color.palette\": function changeMarkerColorPalette(evt, path) {\n        if (!_this._readyOnce) return;\n        _this.redrawDataPoints(null, false);\n      },\n      \"change:marker.select\": function changeMarkerSelect(evt) {\n        if (!_this._readyOnce) return;\n        _this.selectMarkers();\n        _this.redrawDataPoints(null, false);\n        _this.updateOpacity();\n        _this.updateDoubtOpacity();\n      },\n      \"change:marker.opacitySelectDim\": function changeMarkerOpacitySelectDim(evt) {\n        _this.updateOpacity();\n      },\n      \"change:marker.opacityRegular\": function changeMarkerOpacityRegular(evt) {\n        _this.updateOpacity();\n      },\n      \"change:marker.superHighlight\": function changeMarkerSuperHighlight() {\n        return _this2._readyOnce && _this2._blinkSuperHighlighted();\n      }\n    };\n\n    //this._selectlist = new Selectlist(this);\n\n    //contructor is the same as any component\n    this._super(config, context);\n\n    this.sScale = null;\n    this.cScale = d3.scaleOrdinal(d3.schemeCategory10);\n\n    _this.COLOR_WHITEISH = \"#fdfdfd\";\n\n    d3GeoProjection();\n\n    this._labels = new Labels(this);\n    this._labels.config({\n      CSS_PREFIX: \"vzb-bmc\",\n      LABELS_CONTAINER_CLASS: \"vzb-bmc-labels\",\n      LINES_CONTAINER_CLASS: \"vzb-bmc-lines\",\n      SUPPRESS_HIGHLIGHT_DURING_PLAY: false\n    });\n  },\n\n\n  /**\n   * DOM is ready\n   */\n  readyOnce: function readyOnce() {\n\n    this.element = d3.select(this.element);\n\n    this.graph = this.element.select(\".vzb-bmc-graph\");\n    this.mapSvg = this.element.select(\".vzb-bmc-map-background\");\n\n    this.bubbleContainerCrop = this.graph.select(\".vzb-bmc-bubbles-crop\");\n    this.bubbleContainer = this.graph.select(\".vzb-bmc-bubbles\");\n    this.labelListContainer = this.graph.select(\".vzb-bmc-bubble-labels\");\n    this.dataWarningEl = this.graph.select(\".vzb-data-warning\");\n\n    this.yTitleEl = this.graph.select(\".vzb-bmc-axis-y-title\");\n    this.cTitleEl = this.graph.select(\".vzb-bmc-axis-c-title\");\n    this.yInfoEl = this.graph.select(\".vzb-bmc-axis-y-info\");\n    this.cInfoEl = this.graph.select(\".vzb-bmc-axis-c-info\");\n\n    this.entityBubbles = null;\n\n    // year background\n    this.yearEl = this.graph.select(\".vzb-bmc-year\");\n    this.year = new DynamicBackground(this.yearEl);\n    this.year.setConditions({ xAlign: \"left\", yAlign: \"bottom\" });\n\n    var _this = this;\n    this.on(\"resize\", function () {\n      //return if updatesize exists with error\n      if (_this.updateSize()) return;\n      _this.updateMarkerSizeLimits();\n      _this._labels.updateSize();\n      _this.redrawDataPoints();\n      //_this._selectlist.redraw();\n    });\n\n    this.initMap();\n\n    this.KEY = this.model.entities.getDimension();\n    this.TIMEDIM = this.model.time.getDimension();\n\n    this.updateUIStrings();\n\n    this.wScale = d3.scaleLinear().domain(this.model.ui.datawarning.doubtDomain).range(this.model.ui.datawarning.doubtRange);\n\n    this._labels.readyOnce();\n  },\n\n\n  /*\n   * Both model and DOM are ready\n   */\n  ready: function ready() {\n    var _this = this;\n    this.updateUIStrings();\n    this.updateIndicators();\n    this.updateSize();\n    this.updateMarkerSizeLimits();\n    this.model.marker.getFrame(this.model.time.value, function (values, time) {\n      // TODO: temporary fix for case when after data loading time changed on validation\n      if (time.toString() != _this.model.time.value.toString()) {\n        utils.defer(function () {\n          _this.ready();\n        });\n        return;\n      } // frame is outdated\n\n      if (!values) return;\n      _this.values = values;\n      _this.updateEntities();\n      _this.updateTime();\n      _this._labels.ready();\n      _this.redrawDataPoints();\n      _this.highlightMarkers();\n      _this.selectMarkers();\n      //    this._selectlist.redraw();\n      _this.updateDoubtOpacity();\n      _this.updateOpacity();\n    });\n  },\n  frameChanged: function frameChanged(frame, time) {\n    if (time.toString() != this.model.time.value.toString()) return; // frame is outdated\n    if (!frame) return;\n\n    this.values = frame;\n    this.updateTime();\n    this.updateDoubtOpacity();\n    this.redrawDataPoints(null, false);\n  },\n  updateUIStrings: function updateUIStrings() {\n    var _this = this;\n\n    this.translator = this.model.locale.getTFunction();\n    var conceptPropsS = _this.model.marker.size.getConceptprops();\n    var conceptPropsC = _this.model.marker.color.getConceptprops();\n\n    this.strings = {\n      title: {\n        S: conceptPropsS.name,\n        C: conceptPropsC.name\n      }\n    };\n\n    this.yTitleEl.select(\"text\").text(this.translator(\"buttons/size\") + \": \" + this.strings.title.S).on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-treemenu\").markerID(\"size\").alignX(_this.model.locale.isRTL() ? \"right\" : \"left\").alignY(\"top\").updateView().toggle();\n    });\n\n    this.cTitleEl.select(\"text\").text(this.translator(\"buttons/color\") + \": \" + this.strings.title.C).on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-treemenu\").markerID(\"color\").alignX(_this.model.locale.isRTL() ? \"right\" : \"left\").alignY(\"top\").updateView().toggle();\n    });\n\n    utils.setIcon(this.dataWarningEl, iconWarn).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n    this.dataWarningEl.append(\"text\").attr(\"text-anchor\", \"end\").text(this.translator(\"hints/dataWarning\"));\n\n    this.dataWarningEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datawarning\").toggle();\n    }).on(\"mouseover\", function () {\n      _this.updateDoubtOpacity(1);\n    }).on(\"mouseout\", function () {\n      _this.updateDoubtOpacity();\n    });\n\n    this.yInfoEl.html(iconQuestion).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\").style('opacity', Number(Boolean(conceptPropsS.description || conceptPropsS.sourceLink)));\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.yInfoEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.yInfoEl.on(\"mouseover\", function () {\n      var rect = this.getBBox();\n      var coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      var toolRect = _this.root.element.getBoundingClientRect();\n      var chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"size\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.yInfoEl.on(\"mouseout\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n\n    this.cInfoEl.html(iconQuestion).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\").style('opacity', Number(Boolean(conceptPropsC.description || conceptPropsC.sourceLink)));\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.cInfoEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.cInfoEl.on(\"mouseover\", function () {\n      var rect = this.getBBox();\n      var coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      var toolRect = _this.root.element.getBoundingClientRect();\n      var chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"color\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.cInfoEl.on(\"mouseout\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n  },\n\n\n  // show size number on title when hovered on a bubble\n  updateTitleNumbers: function updateTitleNumbers() {\n    var _this = this;\n\n    var mobile = void 0; // if is mobile device and only one bubble is selected, update the ytitle for the bubble\n    if (_this.isMobile && _this.model.marker.select && _this.model.marker.select.length === 1) {\n      mobile = _this.model.marker.select[0];\n    }\n\n    if (_this.hovered || mobile) {\n      var conceptPropsS = _this.model.marker.size.getConceptprops();\n      var conceptPropsC = _this.model.marker.color.getConceptprops();\n\n      var hovered = _this.hovered || mobile;\n      var formatterS = _this.model.marker.size.getTickFormatter();\n      var formatterC = _this.model.marker.color.getTickFormatter();\n\n      var unitS = conceptPropsS.unit || \"\";\n      var unitC = conceptPropsC.unit || \"\";\n\n      var valueS = _this.values.size[hovered[_this.KEY]];\n      var valueC = _this.values.color[hovered[_this.KEY]];\n\n      //resolve value for color from the color legend model\n      if (_this.model.marker.color.isDiscrete() && valueC) {\n        valueC = this.model.marker.color.getColorlegendMarker().label.getItems()[valueC] || \"\";\n      }\n\n      _this.yTitleEl.select(\"text\").text(_this.translator(\"buttons/size\") + \": \" + formatterS(valueS) + \" \" + unitS);\n\n      _this.cTitleEl.select(\"text\").text(_this.translator(\"buttons/color\") + \": \" + (valueC || valueC === 0 ? formatterC(valueC) + \" \" + unitC : _this.translator(\"hints/nodata\")));\n\n      this.yInfoEl.classed(\"vzb-hidden\", true);\n      this.cInfoEl.classed(\"vzb-hidden\", true);\n    } else {\n      this.yTitleEl.select(\"text\").text(this.translator(\"buttons/size\") + \": \" + this.strings.title.S);\n      this.cTitleEl.select(\"text\").text(this.translator(\"buttons/color\") + \": \" + this.strings.title.C);\n\n      this.yInfoEl.classed(\"vzb-hidden\", false);\n      this.cInfoEl.classed(\"vzb-hidden\", false || this.cTitleEl.classed(\"vzb-hidden\"));\n    }\n  },\n  updateDoubtOpacity: function updateDoubtOpacity(opacity) {\n    if (opacity == null) opacity = this.wScale(+this.time.getUTCFullYear().toString());\n    if (this.someSelected) opacity = 1;\n    this.dataWarningEl.style(\"opacity\", opacity);\n  },\n  updateOpacity: function updateOpacity() {\n    var _this = this;\n    /*\n     this.entityBubbles.classed(\"vzb-selected\", function (d) {\n     return _this.model.marker.isSelected(d);\n     });\n     */\n\n    var OPACITY_HIGHLT = 1.0;\n    var OPACITY_HIGHLT_DIM = 0.3;\n    var OPACITY_SELECT = 1.0;\n    var OPACITY_REGULAR = this.model.marker.opacityRegular;\n    var OPACITY_SELECT_DIM = this.model.marker.opacitySelectDim;\n\n    this.entityBubbles.style(\"opacity\", function (d) {\n\n      if (_this.someHighlighted) {\n        //highlight or non-highlight\n        if (_this.model.marker.isHighlighted(d)) return OPACITY_HIGHLT;\n      }\n\n      if (_this.someSelected) {\n        //selected or non-selected\n        return _this.model.marker.isSelected(d) ? OPACITY_SELECT : OPACITY_SELECT_DIM;\n      }\n\n      if (_this.someHighlighted) return OPACITY_HIGHLT_DIM;\n\n      return OPACITY_REGULAR;\n    });\n\n    this.entityBubbles.classed(\"vzb-selected\", function (d) {\n      return _this.model.marker.isSelected(d);\n    });\n\n    var nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n\n    // when pointer events need update...\n    if (nonSelectedOpacityZero !== this.nonSelectedOpacityZero) {\n      this.entityBubbles.style(\"pointer-events\", function (d) {\n        return !_this.someSelected || !nonSelectedOpacityZero || _this.model.marker.isSelected(d) ? \"visible\" : \"none\";\n      });\n    }\n\n    this.nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n  },\n\n\n  /**\n   * Changes labels for indicators\n   */\n  updateIndicators: function updateIndicators() {\n    this.sScale = this.model.marker.size.getScale();\n    this.cScale = this.model.marker.color.getScale();\n  },\n\n\n  /**\n   * Updates entities\n   */\n  updateEntities: function updateEntities() {\n\n    var _this = this;\n    var KEY = this.KEY;\n    var TIMEDIM = this.TIMEDIM;\n\n    var getKeys = function getKeys(prefix) {\n      prefix = prefix || \"\";\n      return _this.model.marker.getKeys().map(function (d) {\n        var pointer = {};\n        pointer[KEY] = d[KEY];\n        pointer[TIMEDIM] = endTime;\n        pointer.sortValue = _this.values.size[d[KEY]] || 0;\n        pointer[KEY] = prefix + d[KEY];\n        return pointer;\n      }).sort(function (a, b) {\n        return b.sortValue - a.sortValue;\n      });\n    };\n\n    // get array of GEOs, sorted by the size hook\n    // that makes larger bubbles go behind the smaller ones\n    var endTime = this.model.time.end;\n    this.model.marker.setVisible(getKeys.call(this));\n\n    //unselecting bubbles with no data is used for the scenario when\n    //some bubbles are selected and user would switch indicator.\n    //bubbles would disappear but selection would stay\n    if (!this.model.time.splash) {\n      this.unselectBubblesWithNoData();\n    }\n\n    // TODO: add to csv\n    //Africa 9.1021° N, 18.2812°E\n    //Europe 53.0000° N, 9.0000° E\n    //Asia 49.8380° N, 105.8203° E\n    //north American 48.1667° N and longitude 100.1667° W\n    /*\n     var pos = {\n     \"afr\": {lat: 9.1, lng: 18.3},\n     \"eur\": {lat: 53.0, lng: 9.0},\n     \"asi\": {lat: 49.8, lng: 105.8},\n     \"ame\": {lat: 48.2, lng: -100.2},\n     };\n     */\n\n    this.entityBubbles = this.bubbleContainer.selectAll(\".vzb-bmc-bubble\").data(this.model.marker.getVisible(), function (d) {\n      return d[KEY];\n    }).order();\n\n    //exit selection\n    this.entityBubbles.exit().remove();\n\n    //enter selection -- init circles\n    this.entityBubbles = this.entityBubbles.enter().append(\"circle\").attr(\"class\", \"vzb-bmc-bubble\").on(\"mouseover\", function (d, i) {\n      if (utils.isTouchDevice()) return;\n      _this._interact()._mouseover(d, i);\n    }).on(\"mouseout\", function (d, i) {\n      if (utils.isTouchDevice()) return;\n      _this._interact()._mouseout(d, i);\n    }).on(\"click\", function (d, i) {\n      if (utils.isTouchDevice()) return;\n      _this._interact()._click(d, i);\n      _this.highlightMarkers();\n    }).onTap(function (d, i) {\n      _this._interact()._click(d, i);\n      d3.event.stopPropagation();\n    }).onLongTap(function (d, i) {}).merge(this.entityBubbles);\n  },\n  unselectBubblesWithNoData: function unselectBubblesWithNoData(frame) {\n    var _this = this;\n    var KEY = this.KEY;\n    if (!frame) frame = this.values;\n\n    if (!frame || !frame.size) return;\n\n    this.model.marker.select.forEach(function (d) {\n      if (!frame.size[d[KEY]] && frame.size[d[KEY]] !== 0) _this.model.marker.selectMarker(d);\n    });\n  },\n  redrawDataPoints: function redrawDataPoints(duration, reposition) {\n    var _this = this;\n    if (!duration) duration = this.duration;\n    if (!reposition) reposition = true;\n    if (!this.entityBubbles) return utils.warn(\"redrawDataPoints(): no entityBubbles defined. likely a premature call, fix it!\");\n    this.entityBubbles.each(function (d, index) {\n      var view = d3.select(this);\n      var geo = d3.select(\"#\" + d[_this.KEY]);\n\n      var valueX = _this.values.hook_lng[d[_this.KEY]];\n      var valueY = _this.values.hook_lat[d[_this.KEY]];\n      var valueS = _this.values.size[d[_this.KEY]];\n      var valueC = _this.values.color[d[_this.KEY]];\n      var valueL = _this.values.label[d[_this.KEY]];\n\n      d.hidden_1 = d.hidden;\n      d.hidden = !valueS && valueS !== 0 || valueX == null || valueY == null;\n\n      if (d.hidden !== d.hidden_1) {\n        if (duration) {\n          view.transition().duration(duration).ease(d3.easeLinear).style(\"opacity\", 0).on(\"end\", function () {\n            return view.classed(\"vzb-hidden\", d.hidden).style(\"opacity\", _this.model.marker.opacityRegular);\n          });\n        } else {\n          view.classed(\"vzb-hidden\", d.hidden);\n        }\n      }\n      if (!d.hidden) {\n\n        d.r = utils.areaToRadius(_this.sScale(valueS || 0));\n        d.label = valueL;\n\n        view.classed(\"vzb-hidden\", false).attr(\"fill\", valueC != null ? _this.cScale(valueC) : _this.COLOR_WHITEISH);\n\n        if (_this.model.ui.map.colorGeo) geo.style(\"fill\", valueC != null ? _this.cScale(valueC) : \"#999\");\n\n        if (reposition) {\n          d.cLoc = _this.skew(_this.projection([valueX || 0, valueY || 0]));\n\n          view.attr(\"cx\", d.cLoc[0]).attr(\"cy\", d.cLoc[1]);\n        }\n\n        if (duration) {\n          view.transition().duration(duration).ease(d3.easeLinear).attr(\"r\", d.r);\n        } else {\n          view.interrupt().attr(\"r\", d.r).transition();\n        }\n\n        _this._updateLabel(d, index, d.cLoc[0], d.cLoc[1], valueS, valueC, d.label, duration);\n      } else {\n        _this._updateLabel(d, index, 0, 0, valueS, valueC, valueL, duration);\n      }\n    });\n  },\n\n\n  /*\n   * UPDATE TIME:\n   * Ideally should only update when time or data changes\n   */\n  updateTime: function updateTime() {\n    var _this = this;\n\n    this.time_1 = this.time == null ? this.model.time.value : this.time;\n    this.time = this.model.time.value;\n    this.duration = this.model.time.playing && this.time - this.time_1 > 0 ? this.model.time.delayAnimations : 0;\n    this.year.setText(this.model.time.formatDate(this.time), this.duration);\n\n    //possibly update the exact value in size title\n    this.updateTitleNumbers();\n  },\n  fitSizeOfTitles: function fitSizeOfTitles() {\n    // reset font sizes first to make the measurement consistent\n    var yTitleText = this.yTitleEl.select(\"text\");\n    yTitleText.style(\"font-size\", null);\n\n    var cTitleText = this.cTitleEl.select(\"text\");\n    cTitleText.style(\"font-size\", null);\n\n    var yTitleBB = yTitleText.node().getBBox();\n    var cTitleBB = this.cTitleEl.classed(\"vzb-hidden\") ? yTitleBB : cTitleText.node().getBBox();\n\n    var font = Math.max(parseInt(yTitleText.style(\"font-size\")), parseInt(cTitleText.style(\"font-size\"))) * this.width / Math.max(yTitleBB.width, cTitleBB.width);\n\n    if (Math.max(yTitleBB.width, cTitleBB.width) > this.width) {\n      yTitleText.style(\"font-size\", font + \"px\");\n      cTitleText.style(\"font-size\", font + \"px\");\n    } else {\n\n      // Else - reset the font size to default so it won't get stuck\n      yTitleText.style(\"font-size\", null);\n      cTitleText.style(\"font-size\", null);\n    }\n  },\n  initMap: function initMap() {\n    var _this3 = this;\n\n    if (!this.topology) utils.warn(\"bubble map afterPreload: missing country shapes \" + this.topology);\n\n    // http://bl.ocks.org/mbostock/d4021aa4dccfd65edffd patterson\n    // http://bl.ocks.org/mbostock/3710566 robinson\n    // map background\n\n    //stage\n\n    this.projection = d3[\"geo\" + utils.capitalize(this.model.ui.map.projection)]();\n\n    this.mapPath = d3.geoPath().projection(this.projection);\n\n    this.mapGraph = this.element.select(\".vzb-bmc-map-graph\");\n    this.mapGraph.html(\"\");\n\n    this.mapFeature = topojson.feature(this.topology, this.topology.objects[this.model.ui.map.topology.objects.geo]);\n    var boundaries = topojson.mesh(this.topology, this.topology.objects[this.model.ui.map.topology.objects.boundaries], function (a, b) {\n      return a !== b;\n    });\n\n    // project to bounding box https://bl.ocks.org/mbostock/4707858\n    this.projection.scale(1).translate([0, 0]);\n\n    this.mapBounds = this.mapPath.bounds(this.mapFeature);\n\n    if (this.mapFeature.features) {\n      this.mapGraph.selectAll(\".land\").data(this.mapFeature.features).enter().insert(\"path\").attr(\"d\", this.mapPath).attr(\"id\", function (d) {\n        return d.properties[_this3.model.ui.map.topology.geoIdProperty].toLowerCase();\n      }).attr(\"class\", \"land\");\n    } else {\n      this.mapGraph.insert(\"path\").datum(this.mapFeature).attr(\"class\", \"land\");\n    }\n\n    this.mapGraph.insert(\"path\").datum(boundaries).attr(\"class\", \"boundary\");\n  },\n\n\n  profiles: {\n    small: {\n      margin: { top: 10, right: 10, left: 10, bottom: 0 },\n      infoElHeight: 16,\n      minRadiusPx: 0.5,\n      maxRadiusEm: 0.05\n    },\n    medium: {\n      margin: { top: 20, right: 20, left: 20, bottom: 30 },\n      infoElHeight: 20,\n      minRadiusPx: 1,\n      maxRadiusEm: 0.05\n    },\n    large: {\n      margin: { top: 30, right: 30, left: 30, bottom: 35 },\n      infoElHeight: 22,\n      minRadiusPx: 1,\n      maxRadiusEm: 0.05\n    }\n  },\n\n  presentationProfileChanges: {\n    medium: {\n      infoElHeight: 26\n    },\n    large: {\n      infoElHeight: 32\n    }\n  },\n\n  /**\n   * Executes everytime the container or vizabi is resized\n   * Ideally,it contains only operations related to size\n   */\n  updateSize: function updateSize() {\n\n    this.activeProfile = this.getActiveProfile(this.profiles, this.presentationProfileChanges);\n\n    var containerWH = this.root.getVizWidthHeight();\n    this.activeProfile.maxRadiusPx = Math.max(this.activeProfile.minRadiusPx, this.activeProfile.maxRadiusEm * utils.hypotenuse(containerWH.width, containerWH.height));\n\n    var margin = this.activeProfile.margin;\n\n    this.height = parseInt(this.element.style(\"height\"), 10) - margin.top - margin.bottom || 0;\n    this.width = parseInt(this.element.style(\"width\"), 10) - margin.left - margin.right || 0;\n\n    if (this.height <= 0 || this.width <= 0) {\n      this.height = 0;\n      this.width = 0;\n      utils.warn(\"Bubble map chart updateSize(): vizabi container is too little or has display:none\");\n    }\n\n    this.repositionElements();\n    this.rescaleMap();\n  },\n  repositionElements: function repositionElements() {\n\n    var margin = this.activeProfile.margin;\n    var infoElHeight = this.activeProfile.infoElHeight;\n    var isRTL = this.model.locale.isRTL();\n\n    this.graph.attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    this.year.setConditions({\n      widthRatio: 2 / 10\n    });\n    this.year.resize(this.width, this.height);\n\n    this.yTitleEl.style(\"font-size\", infoElHeight).attr(\"transform\", \"translate(\" + (isRTL ? this.width : 0) + \",\" + margin.top + \")\");\n\n    var yTitleBB = this.yTitleEl.select(\"text\").node().getBBox();\n\n    //hide the second line about color in large profile or when color is constant\n    this.cTitleEl.attr(\"transform\", \"translate(\" + (isRTL ? this.width : 0) + \",\" + (margin.top + yTitleBB.height) + \")\").classed(\"vzb-hidden\", this.getLayoutProfile() === \"large\" || this.model.marker.color.use == \"constant\");\n\n    var warnBB = this.dataWarningEl.select(\"text\").node().getBBox();\n    this.dataWarningEl.select(\"svg\").attr(\"width\", warnBB.height * 0.75).attr(\"height\", warnBB.height * 0.75).attr(\"x\", -warnBB.width - warnBB.height * 1.2).attr(\"y\", -warnBB.height * 0.65);\n\n    this.dataWarningEl.attr(\"transform\", \"translate(\" + this.width + \",\" + (this.height - warnBB.height * 0.5) + \")\").select(\"text\");\n\n    if (this.yInfoEl.select(\"svg\").node()) {\n      var titleBBox = this.yTitleEl.node().getBBox();\n      var t = utils.transform(this.yTitleEl.node());\n      var hTranslate = isRTL ? titleBBox.x + t.translateX - infoElHeight * 1.4 : titleBBox.x + t.translateX + titleBBox.width + infoElHeight * 0.4;\n\n      this.yInfoEl.select(\"svg\").attr(\"width\", infoElHeight).attr(\"height\", infoElHeight);\n      this.yInfoEl.attr(\"transform\", \"translate(\" + hTranslate + \",\" + (t.translateY - infoElHeight * 0.8) + \")\");\n    }\n\n    this.cInfoEl.classed(\"vzb-hidden\", this.cTitleEl.classed(\"vzb-hidden\"));\n\n    if (!this.cInfoEl.classed(\"vzb-hidden\") && this.cInfoEl.select(\"svg\").node()) {\n      var _titleBBox = this.cTitleEl.node().getBBox();\n      var _t = utils.transform(this.cTitleEl.node());\n      var _hTranslate = isRTL ? _titleBBox.x + _t.translateX - infoElHeight * 1.4 : _titleBBox.x + _t.translateX + _titleBBox.width + infoElHeight * 0.4;\n\n      this.cInfoEl.select(\"svg\").attr(\"width\", infoElHeight).attr(\"height\", infoElHeight);\n      this.cInfoEl.attr(\"transform\", \"translate(\" + _hTranslate + \",\" + (_t.translateY - infoElHeight * 0.8) + \")\");\n    }\n  },\n  rescaleMap: function rescaleMap() {\n\n    var offset = this.model.ui.map.offset;\n    var margin = this.activeProfile.margin;\n\n    // scale to aspect ratio\n    // http://bl.ocks.org/mbostock/4707858\n    var s = this.model.ui.map.scale / Math.max((this.mapBounds[1][0] - this.mapBounds[0][0]) / this.width, (this.mapBounds[1][1] - this.mapBounds[0][1]) / this.height);\n\n    // dimensions of the map itself (regardless of cropping)\n    var mapWidth = s * (this.mapBounds[1][0] - this.mapBounds[0][0]);\n    var mapHeight = s * (this.mapBounds[1][1] - this.mapBounds[0][1]);\n\n    // dimensions of the viewport in which the map is shown (can be bigger or smaller than map)\n    var viewPortHeight = mapHeight * (1 + offset.top + offset.bottom);\n    var viewPortWidth = mapWidth * (1 + offset.left + offset.right);\n    var mapTopOffset = mapHeight * offset.top;\n    var mapLeftOffset = mapWidth * offset.left;\n\n    // translate projection to the middle of map\n    var t = [(mapWidth - s * (this.mapBounds[1][0] + this.mapBounds[0][0])) / 2, (mapHeight - s * (this.mapBounds[1][1] + this.mapBounds[0][1])) / 2];\n\n    this.projection.scale(s).translate(t);\n\n    this.mapGraph.selectAll(\"path\").attr(\"d\", this.mapPath);\n\n    // handle scale to fit case\n    var widthScale = void 0,\n        heightScale = void 0;\n    if (!this.model.ui.map.preserveAspectRatio) {\n\n      // wrap viewBox around viewport so map scales to fit viewport\n      var viewBoxHeight = viewPortHeight;\n      var viewBoxWidth = viewPortWidth;\n\n      // viewport is complete area (apart from scaling)\n      viewPortHeight = this.height * this.model.ui.map.scale;\n      viewPortWidth = this.width * this.model.ui.map.scale;\n\n      this.mapSvg.attr(\"preserveAspectRatio\", \"none\").attr(\"viewBox\", [0, 0, viewBoxWidth, viewBoxHeight].join(\" \"));\n\n      //            ratio between map, viewport and offset (for bubbles)\n      widthScale = viewPortWidth / (mapWidth || 1) / (1 + offset.left + offset.right);\n      heightScale = viewPortHeight / (mapHeight || 1) / (1 + offset.top + offset.bottom);\n    } else {\n\n      // no scaling needed\n      widthScale = 1;\n      heightScale = 1;\n    }\n\n    // internal offset against parent container (mapSvg)\n    this.mapGraph.attr(\"transform\", \"translate(\" + mapLeftOffset + \",\" + mapTopOffset + \")\");\n\n    // resize and put in center\n    this.mapSvg.style(\"transform\", \"translate3d(\" + (margin.left + (this.width - viewPortWidth) / 2) + \"px,\" + (margin.top + (this.height - viewPortHeight) / 2) + \"px,0)\").attr(\"width\", viewPortWidth).attr(\"height\", viewPortHeight);\n\n    // set skew function used for bubbles in chart\n    var _this = this;\n    this.skew = function () {\n      var w = _this.width;\n      var h = _this.height;\n      //input pixel loc after projection, return pixel loc after skew;\n      return function (points) {\n        //      input       scale         translate                    translate offset\n        var x = points[0] * widthScale + (w - viewPortWidth) / 2 + mapLeftOffset * widthScale;\n        var y = points[1] * heightScale + (h - viewPortHeight) / 2 + mapTopOffset * heightScale;\n        return [x, y];\n      };\n    }();\n  },\n  updateMarkerSizeLimits: function updateMarkerSizeLimits() {\n    var _this = this;\n    var extent = this.model.marker.size.extent || [0, 1];\n\n    if (!this.activeProfile) return utils.warn(\"updateMarkerSizeLimits() is called before ready(). This can happen if events get unfrozen and getFrame() still didn't return data\");\n\n    var minRadius = this.activeProfile.minRadiusPx;\n    var maxRadius = this.activeProfile.maxRadiusPx;\n\n    var minArea = utils.radiusToArea(Math.max(maxRadius * extent[0], minRadius));\n    var maxArea = utils.radiusToArea(Math.max(maxRadius * extent[1], minRadius));\n\n    var range = minArea === maxArea ? [minArea, maxArea] : d3.range(minArea, maxArea, (maxArea - minArea) / this.sScale.domain().length).concat(maxArea);\n\n    this.sScale.range(range);\n  },\n  _interact: function _interact() {\n    var _this = this;\n\n    return {\n      _mouseover: function _mouseover(d, i) {\n        if (_this.model.time.dragging) return;\n\n        _this.model.marker.highlightMarker(d);\n\n        _this.hovered = d;\n        //put the exact value in the size title\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n\n        if (_this.model.marker.isSelected(d)) {\n          // if selected, not show hover tooltip\n          _this._setTooltip();\n        } else {\n          //position tooltip\n          _this._setTooltip(d);\n        }\n      },\n      _mouseout: function _mouseout(d, i) {\n        if (_this.model.time.dragging) return;\n        _this._setTooltip();\n        _this.hovered = null;\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n        _this.model.marker.clearHighlighted();\n      },\n      _click: function _click(d, i) {\n        _this.model.marker.selectMarker(d);\n      }\n    };\n  },\n  _blinkSuperHighlighted: function _blinkSuperHighlighted() {\n    var _this4 = this;\n\n    this.entityBubbles.classed(\"vzb-super-highlighted\", function (d) {\n      return _this4.model.marker.isSuperHighlighted(d);\n    });\n  },\n  highlightMarkers: function highlightMarkers() {\n    var _this = this;\n    this.someHighlighted = this.model.marker.highlight.length > 0;\n\n    if (utils.isTouchDevice()) {\n      if (this.someHighlighted) {\n        _this.hovered = this.model.marker.highlight[0];\n      } else {\n        _this.hovered = null;\n      }\n      _this.updateTitleNumbers();\n      _this.fitSizeOfTitles();\n    }\n\n    //      if (!this.selectList || !this.someSelected) return;\n    //      this.selectList.classed(\"vzb-highlight\", function (d) {\n    //          return _this.model.entities.isHighlighted(d);\n    //      });\n    //      this.selectList.each(function (d, i) {\n    //        d3.select(this).selectAll(\".vzb-bmc-label-x\")\n    //          .classed(\"vzb-invisible\", function(n) {\n    //            return !_this.model.entities.isHighlighted(d);\n    //          });\n    //\n    //      });\n  },\n  _updateLabel: function _updateLabel(d, index, valueX, valueY, valueS, valueC, valueL, duration) {\n    var _this = this;\n    var KEY = this.KEY;\n    if (d[KEY] == _this.druging) return;\n    if (duration == null) duration = _this.duration;\n\n    // only for selected entities\n    if (_this.model.marker.isSelected(d)) {\n\n      var showhide = d.hidden !== d.hidden_1;\n      var valueLST = null;\n      var cache = {};\n      cache.labelX0 = valueX / this.width;\n      cache.labelY0 = valueY / this.height;\n      cache.scaledS0 = valueS ? utils.areaToRadius(_this.sScale(valueS)) : null;\n      cache.scaledC0 = valueC != null ? _this.cScale(valueC) : _this.COLOR_WHITEISH;\n\n      this._labels.updateLabel(d, index, cache, valueX / this.width, valueY / this.height, valueS, valueC, valueL, valueLST, duration, showhide);\n    }\n  },\n  selectMarkers: function selectMarkers() {\n    var _this = this;\n    var KEY = this.KEY;\n    this.someSelected = this.model.marker.select.length > 0;\n\n    //      this._selectlist.rebuild();\n    if (utils.isTouchDevice()) {\n      _this._labels.showCloseCross(null, false);\n      if (_this.someHighlighted) {\n        _this.model.marker.clearHighlighted();\n      } else {\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n      }\n    } else {\n      // hide recent hover tooltip\n      if (!_this.hovered || _this.model.marker.isSelected(_this.hovered)) {\n        _this._setTooltip();\n      }\n    }\n\n    this.nonSelectedOpacityZero = false;\n  },\n  _setTooltip: function _setTooltip(d) {\n    if (d) {\n      var KEY = this.KEY;\n      var values = this.values;\n      var labelValues = {};\n      var tooltipCache = {};\n      var mouse = d3.mouse(this.graph.node()).map(function (d) {\n        return parseInt(d);\n      });\n      var x = d.cLoc[0] || mouse[0];\n      var y = d.cLoc[1] || mouse[1];\n      var offset = d.r || 0;\n\n      labelValues.valueS = values.size[d[KEY]];\n      labelValues.labelText = labelValues.valueL = values.label[d[KEY]];\n      tooltipCache.labelX0 = labelValues.valueX = x / this.width;\n      tooltipCache.labelY0 = labelValues.valueY = y / this.height;\n      tooltipCache.scaledS0 = offset;\n      tooltipCache.scaledC0 = null;\n\n      this._labels.setTooltip(d, labelValues.labelText, tooltipCache, labelValues);\n    } else {\n      this._labels.setTooltip();\n    }\n  },\n  preload: function preload() {\n    var _this5 = this;\n\n    var _this = this;\n\n    //this component shall fetch the preload geoshape information from a file\n    var loadFromFile = function loadFromFile(assetName, onSuccess) {\n      _this.model.data.getAsset(assetName, function (response) {\n        _this.topology = response;\n        onSuccess();\n      });\n    };\n\n    //where the path to preload geoshape can be defined either directly in config:\n    var topoPath = utils.getProp(this, [\"model\", \"ui\", \"map\", \"topology\", \"path\"]);\n\n    //or via an entity property in dataset:\n    var topoWhich = utils.getProp(this, [\"model\", \"ui\", \"map\", \"topology\", \"which\"]);\n    var topoKey = utils.getProp(this, [\"model\", \"ui\", \"map\", \"topology\", \"key\"]);\n\n    return new Promise(function (resolve, reject) {\n\n      // priority 1: direct URL to the topojson file\n      if (topoPath) {\n        loadFromFile(topoPath, resolve);\n\n        // priority 2: getting URL to the topojson file via DDF request\n      } else if (topoWhich) {\n        var KEY = _this5.model.entities.dim;\n\n        //build a query to the reader to fetch preload info\n        var query = {\n          language: _this5.model.locale.id,\n          from: \"entities\",\n          select: {\n            key: [KEY],\n            value: [topoWhich]\n          },\n          where: {\n            $and: [_defineProperty({}, KEY, \"$\" + KEY)]\n          },\n          join: _defineProperty({}, \"$\" + KEY, { key: KEY, where: _defineProperty({}, KEY, { $in: [topoKey || \"world\"] }) })\n        };\n\n        var dataPromise = _this5.model.data.load(query, _defineProperty({}, topoWhich, function (d) {\n          return d;\n        }));\n\n        dataPromise.then(function (dataId) {\n          loadFromFile(_this.model.data.getData(dataId)[0][topoWhich], resolve);\n        }, function (err) {\n          return utils.warn(\"Problem with Preload query: \", err, JSON.stringify(query));\n        });\n\n        // priority 3: no clues provided, go for a hardcoded filename for a world map\n      } else {\n        loadFromFile(\"assets/world-50m.json\", resolve);\n      }\n    });\n  }\n});\n\nexports.default = BubbleMapComponent;\n\n/***/ }),\n/* 2 */\n/***/ (function(module, exports) {\n\n// removed by extract-text-webpack-plugin\n\n/***/ }),\n/* 3 */\n/***/ (function(module, exports) {\n\nmodule.exports = \"<!-- Bubble Map Chart Component -->\\n<div class=\\\"vzb-bubblemap\\\">\\n    <svg class=\\\"vzb-bmc-map-background vzb-export\\\">\\n        <g class=\\\"vzb-bmc-map-graph\\\"></g>\\n    </svg>\\n    <svg class=\\\"vzb-bubblemap-svg vzb-export\\\">\\n        <g class=\\\"vzb-bmc-graph\\\">\\n            <g class=\\\"vzb-bmc-year\\\"></g>\\n\\n            <g class=\\\"vzb-bmc-lines\\\"></g>\\n            <g class=\\\"vzb-bmc-bubbles\\\"></g>\\n            <g class=\\\"vzb-bmc-bubble-labels\\\"></g>\\n\\n\\n            <g class=\\\"vzb-bmc-axis-y-title\\\">\\n                <text></text>\\n            </g>\\n\\n            <g class=\\\"vzb-bmc-axis-c-title\\\">\\n                <text></text>\\n            </g>\\n\\n            <g class=\\\"vzb-bmc-axis-y-info vzb-noexport\\\">\\n            </g>\\n\\n            <g class=\\\"vzb-bmc-axis-c-info vzb-noexport\\\">\\n            </g>\\n\\n            <g class=\\\"vzb-data-warning vzb-noexport\\\">\\n                <svg></svg>\\n                <text></text>\\n            </g>\\n            <g class=\\\"vzb-bmc-labels\\\"></g>\\n        </g>\\n    </svg>\\n</div>\\n\";\n\n/***/ }),\n/* 4 */\n/***/ (function(module, exports, __webpack_require__) {\n\nmodule.exports = __webpack_require__(0);\n\n\n/***/ })\n/******/ ]);\n\n\n// WEBPACK FOOTER //\n// bubblemap.js"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap b5e5e27b81f1b74b35c5","import \"./styles.scss\";\nimport component from \"./component\";\n\nconst VERSION_INFO = { version: __VERSION, build: __BUILD };\n\n//BAR CHART TOOL\nconst BubbleMap = Vizabi.Tool.extend(\"BubbleMap\", {\n\n\n  /**\n   * Initializes the tool (Bar Chart Tool).\n   * Executed once before any template is rendered.\n   * @param {Object} placeholder Placeholder element for the tool\n   * @param {Object} external_model Model as given by the external page\n   */\n  init(placeholder, external_model) {\n\n    this.name = \"bubblemap\";\n\n    //specifying components\n    this.components = [{\n      component,\n      placeholder: \".vzb-tool-viz\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"locale\", \"ui\", \"data\"] //pass models to component\n    }, {\n      component: Vizabi.Component.get(\"timeslider\"),\n      placeholder: \".vzb-tool-timeslider\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"ui\"]\n    }, {\n      component: Vizabi.Component.get(\"dialogs\"),\n      placeholder: \".vzb-tool-dialogs\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"buttonlist\"),\n      placeholder: \".vzb-tool-buttonlist\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"treemenu\"),\n      placeholder: \".vzb-tool-treemenu\",\n      model: [\"state.marker\", \"state.marker_tags\", \"state.time\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datawarning\"),\n      placeholder: \".vzb-tool-datawarning\",\n      model: [\"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datanotes\"),\n      placeholder: \".vzb-tool-datanotes\",\n      model: [\"state.marker\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"steppedspeedslider\"),\n      placeholder: \".vzb-tool-stepped-speed-slider\",\n      model: [\"state.time\", \"locale\"]\n    }\n    ];\n\n    //constructor is the same as any tool\n    this._super(placeholder, external_model);\n  },\n\n  default_model: {\n    state: {\n      time: {\n        \"delay\": 100,\n        \"delayThresholdX2\": 50,\n        \"delayThresholdX4\": 25\n      },\n      entities: {\n        \"opacitySelectDim\": 0.3,\n        \"opacityRegular\": 1\n      }\n    },\n    locale: { },\n    ui: {\n      map: {\n        path: null,\n        colorGeo: false,\n        preserveAspectRatio: true,\n        scale: 0.95,\n        offset: {\n          top: 0,\n          right: 0,\n          bottom: 0,\n          left: 0\n        },\n        projection: \"robinson\",\n        topology: {\n          path: null,\n          objects: {\n            geo: \"land\",\n            boundaries: \"countries\"\n          },\n          geoIdProperty: null,\n        }\n      },\n      chart: {\n        superhighlightOnMinimapHover: true,\n        labels: {\n          dragging: true\n        }\n      },\n      datawarning: {\n        doubtDomain: [],\n        doubtRange: []\n      },\n      \"buttons\": [\"colors\", \"find\", \"size\", \"moreoptions\", \"fullscreen\", \"presentation\"],\n      \"dialogs\": {\n        \"popup\": [\"colors\", \"find\", \"size\", \"moreoptions\"],\n        \"sidebar\": [\"colors\", \"find\", \"size\"],\n        \"moreoptions\": [\"opacity\", \"speed\", \"size\", \"colors\", \"presentation\", \"about\"]\n      },\n      presentation: false\n    }\n  },\n\n  versionInfo: VERSION_INFO\n});\n\nexport default BubbleMap;\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","const {\n  _globals: globals,\n  utils,\n  Component,\n  helpers: {\n    labels: Labels,\n    topojson,\n    \"d3.geoProjection\": d3GeoProjection,\n    \"d3.dynamicBackground\": DynamicBackground,\n  },\n  iconset: {\n    warn: iconWarn,\n    question: iconQuestion,\n  },\n} = Vizabi;\n\n\n// BUBBLE MAP CHART COMPONENT\nconst BubbleMapComponent = Component.extend(\"bubblemap\", {\n  /**\n   * Initializes the component (Bubble Map Chart).\n   * Executed once before any template is rendered.\n   * @param {Object} config The config passed to the component\n   * @param {Object} context The component's parent\n   */\n  init(config, context) {\n    this.name = \"bubblemap\";\n    this.template = require(\"./template.html\");\n    this.bubblesDrawing = null;\n\n\n    this.isMobile = utils.isMobileOrTablet();\n\n    //define expected models for this component\n    this.model_expects = [\n      {\n        name: \"time\",\n        type: \"time\"\n      },\n      {\n        name: \"entities\",\n        type: \"entities\"\n      },\n      {\n        name: \"marker\",\n        type: \"marker\"\n      },\n      {\n        name: \"locale\",\n        type: \"locale\"\n      },\n      {\n        name: \"ui\",\n        type: \"ui\"\n      },\n      {\n        name: \"data\",\n        type: \"data\"\n      }\n    ];\n\n    const _this = this;\n    this.model_binds = {\n      \"change:time.value\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this.model.marker.getFrame(_this.model.time.value, _this.frameChanged.bind(_this));\n      },\n      \"change:marker.highlight\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this.highlightMarkers();\n        _this.updateOpacity();\n      },\n      \"change:marker\": function(evt, path) {\n        // bubble size change is processed separately\n        if (!_this._readyOnce) return;\n\n        if (path.indexOf(\"scaleType\") > -1) {\n          _this.ready();\n        }\n      },\n      \"change:marker.size.extent\": function(evt, path) {\n        //console.log(\"EVENT change:marker:size:max\");\n        if (!_this._readyOnce || !_this.entityBubbles) return;\n        _this.updateMarkerSizeLimits();\n        _this.redrawDataPoints(null, false);\n      },\n      \"change:marker.color.palette\": function(evt, path) {\n        if (!_this._readyOnce) return;\n        _this.redrawDataPoints(null, false);\n      },\n      \"change:marker.select\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this.selectMarkers();\n        _this.redrawDataPoints(null, false);\n        _this.updateOpacity();\n        _this.updateDoubtOpacity();\n\n      },\n      \"change:marker.opacitySelectDim\": function(evt) {\n        _this.updateOpacity();\n      },\n      \"change:marker.opacityRegular\": function(evt) {\n        _this.updateOpacity();\n      },\n      \"change:marker.superHighlight\": () => this._readyOnce && this._blinkSuperHighlighted(),\n    };\n\n    //this._selectlist = new Selectlist(this);\n\n    //contructor is the same as any component\n    this._super(config, context);\n\n    this.sScale = null;\n    this.cScale = d3.scaleOrdinal(d3.schemeCategory10);\n\n    _this.COLOR_WHITEISH = \"#fdfdfd\";\n\n    d3GeoProjection();\n\n    this._labels = new Labels(this);\n    this._labels.config({\n      CSS_PREFIX: \"vzb-bmc\",\n      LABELS_CONTAINER_CLASS: \"vzb-bmc-labels\",\n      LINES_CONTAINER_CLASS: \"vzb-bmc-lines\",\n      SUPPRESS_HIGHLIGHT_DURING_PLAY: false\n    });\n  },\n\n\n  /**\n   * DOM is ready\n   */\n  readyOnce() {\n\n    this.element = d3.select(this.element);\n\n    this.graph = this.element.select(\".vzb-bmc-graph\");\n    this.mapSvg = this.element.select(\".vzb-bmc-map-background\");\n\n    this.bubbleContainerCrop = this.graph.select(\".vzb-bmc-bubbles-crop\");\n    this.bubbleContainer = this.graph.select(\".vzb-bmc-bubbles\");\n    this.labelListContainer = this.graph.select(\".vzb-bmc-bubble-labels\");\n    this.dataWarningEl = this.graph.select(\".vzb-data-warning\");\n\n    this.yTitleEl = this.graph.select(\".vzb-bmc-axis-y-title\");\n    this.cTitleEl = this.graph.select(\".vzb-bmc-axis-c-title\");\n    this.yInfoEl = this.graph.select(\".vzb-bmc-axis-y-info\");\n    this.cInfoEl = this.graph.select(\".vzb-bmc-axis-c-info\");\n\n    this.entityBubbles = null;\n\n    // year background\n    this.yearEl = this.graph.select(\".vzb-bmc-year\");\n    this.year = new DynamicBackground(this.yearEl);\n    this.year.setConditions({ xAlign: \"left\", yAlign: \"bottom\" });\n\n    const _this = this;\n    this.on(\"resize\", () => {\n      //return if updatesize exists with error\n      if (_this.updateSize()) return;\n      _this.updateMarkerSizeLimits();\n      _this._labels.updateSize();\n      _this.redrawDataPoints();\n      //_this._selectlist.redraw();\n\n    });\n\n    this.initMap();\n\n    this.KEY = this.model.entities.getDimension();\n    this.TIMEDIM = this.model.time.getDimension();\n\n    this.updateUIStrings();\n\n    this.wScale = d3.scaleLinear()\n      .domain(this.model.ui.datawarning.doubtDomain)\n      .range(this.model.ui.datawarning.doubtRange);\n\n    this._labels.readyOnce();\n  },\n\n  /*\n   * Both model and DOM are ready\n   */\n  ready() {\n    const _this = this;\n    this.updateUIStrings();\n    this.updateIndicators();\n    this.updateSize();\n    this.updateMarkerSizeLimits();\n    this.model.marker.getFrame(this.model.time.value, (values, time) => {\n      // TODO: temporary fix for case when after data loading time changed on validation\n      if (time.toString() != _this.model.time.value.toString()) {\n        utils.defer(() => {\n          _this.ready();\n        });\n        return;\n      } // frame is outdated\n\n      if (!values) return;\n      _this.values = values;\n      _this.updateEntities();\n      _this.updateTime();\n      _this._labels.ready();\n      _this.redrawDataPoints();\n      _this.highlightMarkers();\n      _this.selectMarkers();\n//    this._selectlist.redraw();\n      _this.updateDoubtOpacity();\n      _this.updateOpacity();\n    });\n\n  },\n\n  frameChanged(frame, time) {\n    if (time.toString() != this.model.time.value.toString()) return; // frame is outdated\n    if (!frame) return;\n\n    this.values = frame;\n    this.updateTime();\n    this.updateDoubtOpacity();\n    this.redrawDataPoints(null, false);\n\n  },\n\n  updateUIStrings() {\n    const _this = this;\n\n    this.translator = this.model.locale.getTFunction();\n    const conceptPropsS = _this.model.marker.size.getConceptprops();\n    const conceptPropsC = _this.model.marker.color.getConceptprops();\n\n    this.strings = {\n      title: {\n        S: conceptPropsS.name,\n        C: conceptPropsC.name\n      }\n    };\n\n    this.yTitleEl.select(\"text\")\n      .text(this.translator(\"buttons/size\") + \": \" + this.strings.title.S)\n      .on(\"click\", () => {\n        _this.parent\n          .findChildByName(\"gapminder-treemenu\")\n          .markerID(\"size\")\n          .alignX(_this.model.locale.isRTL() ? \"right\" : \"left\")\n          .alignY(\"top\")\n          .updateView()\n          .toggle();\n      });\n\n    this.cTitleEl.select(\"text\")\n      .text(this.translator(\"buttons/color\") + \": \" + this.strings.title.C)\n      .on(\"click\", () => {\n        _this.parent\n          .findChildByName(\"gapminder-treemenu\")\n          .markerID(\"color\")\n          .alignX(_this.model.locale.isRTL() ? \"right\" : \"left\")\n          .alignY(\"top\")\n          .updateView()\n          .toggle();\n      });\n\n    utils.setIcon(this.dataWarningEl, iconWarn).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n    this.dataWarningEl.append(\"text\")\n      .attr(\"text-anchor\", \"end\")\n      .text(this.translator(\"hints/dataWarning\"));\n\n    this.dataWarningEl\n      .on(\"click\", () => {\n        _this.parent.findChildByName(\"gapminder-datawarning\").toggle();\n      })\n      .on(\"mouseover\", () => {\n        _this.updateDoubtOpacity(1);\n      })\n      .on(\"mouseout\", () => {\n        _this.updateDoubtOpacity();\n      });\n\n    this.yInfoEl\n      .html(iconQuestion)\n      .select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\")\n      .style('opacity', Number(Boolean(conceptPropsS.description || conceptPropsS.sourceLink)));\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.yInfoEl.on(\"click\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.yInfoEl.on(\"mouseover\", function() {\n      const rect = this.getBBox();\n      const coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      const toolRect = _this.root.element.getBoundingClientRect();\n      const chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"size\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.yInfoEl.on(\"mouseout\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n\n    this.cInfoEl\n      .html(iconQuestion)\n      .select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\")\n      .style('opacity', Number(Boolean(conceptPropsC.description || conceptPropsC.sourceLink)));\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.cInfoEl.on(\"click\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.cInfoEl.on(\"mouseover\", function() {\n      const rect = this.getBBox();\n      const coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      const toolRect = _this.root.element.getBoundingClientRect();\n      const chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"color\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.cInfoEl.on(\"mouseout\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n  },\n\n  // show size number on title when hovered on a bubble\n  updateTitleNumbers() {\n    const _this = this;\n\n    let mobile; // if is mobile device and only one bubble is selected, update the ytitle for the bubble\n    if (_this.isMobile && _this.model.marker.select && _this.model.marker.select.length === 1) {\n      mobile = _this.model.marker.select[0];\n    }\n\n    if (_this.hovered || mobile) {\n      const conceptPropsS = _this.model.marker.size.getConceptprops();\n      const conceptPropsC = _this.model.marker.color.getConceptprops();\n\n      const hovered = _this.hovered || mobile;\n      const formatterS = _this.model.marker.size.getTickFormatter();\n      const formatterC = _this.model.marker.color.getTickFormatter();\n\n      const unitS = conceptPropsS.unit || \"\";\n      const unitC = conceptPropsC.unit || \"\";\n\n      const valueS = _this.values.size[hovered[_this.KEY]];\n      let valueC = _this.values.color[hovered[_this.KEY]];\n\n      //resolve value for color from the color legend model\n      if (_this.model.marker.color.isDiscrete() && valueC) {\n        valueC = this.model.marker.color.getColorlegendMarker().label.getItems()[valueC] || \"\";\n      }\n\n      _this.yTitleEl.select(\"text\")\n        .text(_this.translator(\"buttons/size\") + \": \" + formatterS(valueS) + \" \" + unitS);\n\n      _this.cTitleEl.select(\"text\")\n        .text(_this.translator(\"buttons/color\") + \": \" +\n          (valueC || valueC === 0 ? formatterC(valueC) + \" \" + unitC : _this.translator(\"hints/nodata\")));\n\n      this.yInfoEl.classed(\"vzb-hidden\", true);\n      this.cInfoEl.classed(\"vzb-hidden\", true);\n    } else {\n      this.yTitleEl.select(\"text\")\n        .text(this.translator(\"buttons/size\") + \": \" + this.strings.title.S);\n      this.cTitleEl.select(\"text\")\n        .text(this.translator(\"buttons/color\") + \": \" + this.strings.title.C);\n\n      this.yInfoEl.classed(\"vzb-hidden\", false);\n      this.cInfoEl.classed(\"vzb-hidden\", false || this.cTitleEl.classed(\"vzb-hidden\"));\n    }\n  },\n\n  updateDoubtOpacity(opacity) {\n    if (opacity == null) opacity = this.wScale(+this.time.getUTCFullYear().toString());\n    if (this.someSelected) opacity = 1;\n    this.dataWarningEl.style(\"opacity\", opacity);\n  },\n\n  updateOpacity() {\n    const _this = this;\n    /*\n     this.entityBubbles.classed(\"vzb-selected\", function (d) {\n     return _this.model.marker.isSelected(d);\n     });\n     */\n\n    const OPACITY_HIGHLT = 1.0;\n    const OPACITY_HIGHLT_DIM = 0.3;\n    const OPACITY_SELECT = 1.0;\n    const OPACITY_REGULAR = this.model.marker.opacityRegular;\n    const OPACITY_SELECT_DIM = this.model.marker.opacitySelectDim;\n\n    this.entityBubbles.style(\"opacity\", d => {\n\n      if (_this.someHighlighted) {\n        //highlight or non-highlight\n        if (_this.model.marker.isHighlighted(d)) return OPACITY_HIGHLT;\n      }\n\n      if (_this.someSelected) {\n        //selected or non-selected\n        return _this.model.marker.isSelected(d) ? OPACITY_SELECT : OPACITY_SELECT_DIM;\n      }\n\n      if (_this.someHighlighted) return OPACITY_HIGHLT_DIM;\n\n      return OPACITY_REGULAR;\n\n    });\n\n    this.entityBubbles.classed(\"vzb-selected\", d => _this.model.marker.isSelected(d));\n\n    const nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n\n    // when pointer events need update...\n    if (nonSelectedOpacityZero !== this.nonSelectedOpacityZero) {\n      this.entityBubbles.style(\"pointer-events\", d => (!_this.someSelected || !nonSelectedOpacityZero || _this.model.marker.isSelected(d)) ?\n        \"visible\" : \"none\");\n    }\n\n    this.nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n  },\n\n  /**\n   * Changes labels for indicators\n   */\n  updateIndicators() {\n    this.sScale = this.model.marker.size.getScale();\n    this.cScale = this.model.marker.color.getScale();\n  },\n\n  /**\n   * Updates entities\n   */\n  updateEntities() {\n\n    const _this = this;\n    const KEY = this.KEY;\n    const TIMEDIM = this.TIMEDIM;\n\n    const getKeys = function(prefix) {\n      prefix = prefix || \"\";\n      return _this.model.marker.getKeys()\n        .map(d => {\n          const pointer = {};\n          pointer[KEY] = d[KEY];\n          pointer[TIMEDIM] = endTime;\n          pointer.sortValue = _this.values.size[d[KEY]] || 0;\n          pointer[KEY] = prefix + d[KEY];\n          return pointer;\n        })\n        .sort((a, b) => b.sortValue - a.sortValue);\n    };\n\n    // get array of GEOs, sorted by the size hook\n    // that makes larger bubbles go behind the smaller ones\n    const endTime = this.model.time.end;\n    this.model.marker.setVisible(getKeys.call(this));\n\n    //unselecting bubbles with no data is used for the scenario when\n    //some bubbles are selected and user would switch indicator.\n    //bubbles would disappear but selection would stay\n    if (!this.model.time.splash) {\n      this.unselectBubblesWithNoData();\n    }\n\n    // TODO: add to csv\n    //Africa 9.1021° N, 18.2812°E\n    //Europe 53.0000° N, 9.0000° E\n    //Asia 49.8380° N, 105.8203° E\n    //north American 48.1667° N and longitude 100.1667° W\n    /*\n     var pos = {\n     \"afr\": {lat: 9.1, lng: 18.3},\n     \"eur\": {lat: 53.0, lng: 9.0},\n     \"asi\": {lat: 49.8, lng: 105.8},\n     \"ame\": {lat: 48.2, lng: -100.2},\n     };\n     */\n\n\n    this.entityBubbles = this.bubbleContainer.selectAll(\".vzb-bmc-bubble\")\n      .data(this.model.marker.getVisible(), d => d[KEY])\n      .order();\n\n    //exit selection\n    this.entityBubbles.exit().remove();\n\n    //enter selection -- init circles\n    this.entityBubbles = this.entityBubbles.enter().append(\"circle\")\n      .attr(\"class\", \"vzb-bmc-bubble\")\n      .on(\"mouseover\", (d, i) => {\n        if (utils.isTouchDevice()) return;\n        _this._interact()._mouseover(d, i);\n      })\n      .on(\"mouseout\", (d, i) => {\n        if (utils.isTouchDevice()) return;\n        _this._interact()._mouseout(d, i);\n      })\n      .on(\"click\", (d, i) => {\n        if (utils.isTouchDevice()) return;\n        _this._interact()._click(d, i);\n        _this.highlightMarkers();\n      })\n      .onTap((d, i) => {\n        _this._interact()._click(d, i);\n        d3.event.stopPropagation();\n      })\n      .onLongTap((d, i) => {\n      })\n      .merge(this.entityBubbles);\n\n  },\n\n  unselectBubblesWithNoData(frame) {\n    const _this = this;\n    const KEY = this.KEY;\n    if (!frame) frame = this.values;\n\n    if (!frame || !frame.size) return;\n\n    this.model.marker.select.forEach(d => {\n      if (!frame.size[d[KEY]] && frame.size[d[KEY]] !== 0)\n        _this.model.marker.selectMarker(d);\n    });\n  },\n\n  redrawDataPoints(duration, reposition) {\n    const _this = this;\n    if (!duration) duration = this.duration;\n    if (!reposition) reposition = true;\n    if (!this.entityBubbles) return utils.warn(\"redrawDataPoints(): no entityBubbles defined. likely a premature call, fix it!\");\n    this.entityBubbles.each(function(d, index) {\n      const view = d3.select(this);\n      const geo = d3.select(\"#\" + d[_this.KEY]);\n\n      const valueX = _this.values.hook_lng[d[_this.KEY]];\n      const valueY = _this.values.hook_lat[d[_this.KEY]];\n      const valueS = _this.values.size[d[_this.KEY]];\n      const valueC = _this.values.color[d[_this.KEY]];\n      const valueL = _this.values.label[d[_this.KEY]];\n\n      d.hidden_1 = d.hidden;\n      d.hidden = (!valueS && valueS !== 0) || valueX == null || valueY == null;\n\n\n      if (d.hidden !== d.hidden_1) {\n        if (duration) {\n          view.transition().duration(duration).ease(d3.easeLinear)\n            .style(\"opacity\", 0)\n            .on(\"end\", () => view.classed(\"vzb-hidden\", d.hidden).style(\"opacity\", _this.model.marker.opacityRegular));\n        } else {\n          view.classed(\"vzb-hidden\", d.hidden);\n        }\n      }\n      if (!d.hidden) {\n\n        d.r = utils.areaToRadius(_this.sScale(valueS || 0));\n        d.label = valueL;\n\n        view.classed(\"vzb-hidden\", false)\n          .attr(\"fill\", valueC != null ? _this.cScale(valueC) : _this.COLOR_WHITEISH);\n\n        if (_this.model.ui.map.colorGeo)\n          geo.style(\"fill\", valueC != null ? _this.cScale(valueC) : \"#999\");\n\n        if (reposition) {\n          d.cLoc = _this.skew(_this.projection([valueX || 0, valueY || 0]));\n\n          view.attr(\"cx\", d.cLoc[0])\n            .attr(\"cy\", d.cLoc[1]);\n        }\n\n        if (duration) {\n          view.transition().duration(duration).ease(d3.easeLinear)\n            .attr(\"r\", d.r);\n        } else {\n          view.interrupt()\n            .attr(\"r\", d.r)\n            .transition();\n        }\n\n        _this._updateLabel(d, index, d.cLoc[0], d.cLoc[1], valueS, valueC, d.label, duration);\n      } else {\n        _this._updateLabel(d, index, 0, 0, valueS, valueC, valueL, duration);\n      }\n\n    });\n  },\n\n  /*\n   * UPDATE TIME:\n   * Ideally should only update when time or data changes\n   */\n  updateTime() {\n    const _this = this;\n\n    this.time_1 = this.time == null ? this.model.time.value : this.time;\n    this.time = this.model.time.value;\n    this.duration = this.model.time.playing && (this.time - this.time_1 > 0) ? this.model.time.delayAnimations : 0;\n    this.year.setText(this.model.time.formatDate(this.time), this.duration);\n\n    //possibly update the exact value in size title\n    this.updateTitleNumbers();\n  },\n\n\n  fitSizeOfTitles() {\n    // reset font sizes first to make the measurement consistent\n    const yTitleText = this.yTitleEl.select(\"text\");\n    yTitleText.style(\"font-size\", null);\n\n    const cTitleText = this.cTitleEl.select(\"text\");\n    cTitleText.style(\"font-size\", null);\n\n    const yTitleBB = yTitleText.node().getBBox();\n    const cTitleBB = this.cTitleEl.classed(\"vzb-hidden\") ? yTitleBB : cTitleText.node().getBBox();\n\n    const font =\n      Math.max(parseInt(yTitleText.style(\"font-size\")), parseInt(cTitleText.style(\"font-size\")))\n      * this.width / Math.max(yTitleBB.width, cTitleBB.width);\n\n    if (Math.max(yTitleBB.width, cTitleBB.width) > this.width) {\n      yTitleText.style(\"font-size\", font + \"px\");\n      cTitleText.style(\"font-size\", font + \"px\");\n    } else {\n\n      // Else - reset the font size to default so it won't get stuck\n      yTitleText.style(\"font-size\", null);\n      cTitleText.style(\"font-size\", null);\n    }\n\n  },\n\n  initMap() {\n    if (!this.topology) utils.warn(\"bubble map afterPreload: missing country shapes \" + this.topology);\n\n    // http://bl.ocks.org/mbostock/d4021aa4dccfd65edffd patterson\n    // http://bl.ocks.org/mbostock/3710566 robinson\n    // map background\n\n    //stage\n\n    this.projection = d3[\"geo\" + utils.capitalize(this.model.ui.map.projection)]();\n\n    this.mapPath = d3.geoPath()\n      .projection(this.projection);\n\n    this.mapGraph = this.element.select(\".vzb-bmc-map-graph\");\n    this.mapGraph.html(\"\");\n\n    this.mapFeature = topojson.feature(this.topology, this.topology.objects[this.model.ui.map.topology.objects.geo]);\n    const boundaries = topojson.mesh(this.topology, this.topology.objects[this.model.ui.map.topology.objects.boundaries], (a, b) => a !== b);\n\n    // project to bounding box https://bl.ocks.org/mbostock/4707858\n    this.projection\n      .scale(1)\n      .translate([0, 0]);\n\n    this.mapBounds = this.mapPath.bounds(this.mapFeature);\n\n    if (this.mapFeature.features) {\n      this.mapGraph.selectAll(\".land\")\n        .data(this.mapFeature.features)\n        .enter().insert(\"path\")\n        .attr(\"d\", this.mapPath)\n        .attr(\"id\", d => d.properties[this.model.ui.map.topology.geoIdProperty].toLowerCase())\n        .attr(\"class\", \"land\");\n    } else {\n      this.mapGraph.insert(\"path\")\n        .datum(this.mapFeature)\n        .attr(\"class\", \"land\");\n    }\n\n    this.mapGraph.insert(\"path\")\n      .datum(boundaries)\n      .attr(\"class\", \"boundary\");\n  },\n\n  profiles: {\n    small: {\n      margin: { top: 10, right: 10, left: 10, bottom: 0 },\n      infoElHeight: 16,\n      minRadiusPx: 0.5,\n      maxRadiusEm: 0.05\n    },\n    medium: {\n      margin: { top: 20, right: 20, left: 20, bottom: 30 },\n      infoElHeight: 20,\n      minRadiusPx: 1,\n      maxRadiusEm: 0.05\n    },\n    large: {\n      margin: { top: 30, right: 30, left: 30, bottom: 35 },\n      infoElHeight: 22,\n      minRadiusPx: 1,\n      maxRadiusEm: 0.05\n    }\n  },\n\n  presentationProfileChanges: {\n    medium: {\n      infoElHeight: 26\n    },\n    large: {\n      infoElHeight: 32\n    }\n  },\n\n  /**\n   * Executes everytime the container or vizabi is resized\n   * Ideally,it contains only operations related to size\n   */\n  updateSize() {\n\n    this.activeProfile = this.getActiveProfile(this.profiles, this.presentationProfileChanges);\n\n    const containerWH = this.root.getVizWidthHeight();\n    this.activeProfile.maxRadiusPx = Math.max(\n      this.activeProfile.minRadiusPx,\n      this.activeProfile.maxRadiusEm * utils.hypotenuse(containerWH.width, containerWH.height)\n    );\n\n    const margin = this.activeProfile.margin;\n\n    this.height = (parseInt(this.element.style(\"height\"), 10) - margin.top - margin.bottom) || 0;\n    this.width = (parseInt(this.element.style(\"width\"), 10) - margin.left - margin.right) || 0;\n\n    if (this.height <= 0 || this.width <= 0) {\n      this.height = 0;\n      this.width = 0;\n      utils.warn(\"Bubble map chart updateSize(): vizabi container is too little or has display:none\");\n    }\n\n    this.repositionElements();\n    this.rescaleMap();\n\n  },\n\n  repositionElements() {\n\n    const margin = this.activeProfile.margin;\n    const infoElHeight = this.activeProfile.infoElHeight;\n    const isRTL = this.model.locale.isRTL();\n\n    this.graph\n      .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    this.year.setConditions({\n      widthRatio: 2 / 10\n    });\n    this.year.resize(this.width, this.height);\n\n    this.yTitleEl\n      .style(\"font-size\", infoElHeight)\n      .attr(\"transform\", \"translate(\" + (isRTL ? this.width : 0) + \",\" + margin.top + \")\");\n\n    const yTitleBB = this.yTitleEl.select(\"text\").node().getBBox();\n\n    //hide the second line about color in large profile or when color is constant\n    this.cTitleEl.attr(\"transform\", \"translate(\" + (isRTL ? this.width : 0) + \",\" + (margin.top + yTitleBB.height) + \")\")\n      .classed(\"vzb-hidden\", this.getLayoutProfile() === \"large\" || this.model.marker.color.use == \"constant\");\n\n    const warnBB = this.dataWarningEl.select(\"text\").node().getBBox();\n    this.dataWarningEl.select(\"svg\")\n      .attr(\"width\", warnBB.height * 0.75)\n      .attr(\"height\", warnBB.height * 0.75)\n      .attr(\"x\", -warnBB.width - warnBB.height * 1.2)\n      .attr(\"y\", -warnBB.height * 0.65);\n\n    this.dataWarningEl\n      .attr(\"transform\", \"translate(\" + (this.width) + \",\" + (this.height - warnBB.height * 0.5) + \")\")\n      .select(\"text\");\n\n    if (this.yInfoEl.select(\"svg\").node()) {\n      const titleBBox = this.yTitleEl.node().getBBox();\n      const t = utils.transform(this.yTitleEl.node());\n      const hTranslate = isRTL ? (titleBBox.x + t.translateX - infoElHeight * 1.4) : (titleBBox.x + t.translateX + titleBBox.width + infoElHeight * 0.4);\n\n      this.yInfoEl.select(\"svg\")\n        .attr(\"width\", infoElHeight)\n        .attr(\"height\", infoElHeight);\n      this.yInfoEl.attr(\"transform\", \"translate(\"\n        + hTranslate + \",\"\n        + (t.translateY - infoElHeight * 0.8) + \")\");\n    }\n\n    this.cInfoEl.classed(\"vzb-hidden\", this.cTitleEl.classed(\"vzb-hidden\"));\n\n    if (!this.cInfoEl.classed(\"vzb-hidden\") && this.cInfoEl.select(\"svg\").node()) {\n      const titleBBox = this.cTitleEl.node().getBBox();\n      const t = utils.transform(this.cTitleEl.node());\n      const hTranslate = isRTL ? (titleBBox.x + t.translateX - infoElHeight * 1.4) : (titleBBox.x + t.translateX + titleBBox.width + infoElHeight * 0.4);\n\n      this.cInfoEl.select(\"svg\")\n        .attr(\"width\", infoElHeight)\n        .attr(\"height\", infoElHeight);\n      this.cInfoEl.attr(\"transform\", \"translate(\"\n        + hTranslate + \",\"\n        + (t.translateY - infoElHeight * 0.8) + \")\");\n    }\n  },\n\n  rescaleMap() {\n\n    const offset = this.model.ui.map.offset;\n    const margin = this.activeProfile.margin;\n\n    // scale to aspect ratio\n    // http://bl.ocks.org/mbostock/4707858\n    const s = this.model.ui.map.scale / Math.max((this.mapBounds[1][0] - this.mapBounds[0][0]) / this.width, (this.mapBounds[1][1] - this.mapBounds[0][1]) / this.height);\n\n    // dimensions of the map itself (regardless of cropping)\n    const mapWidth = (s * (this.mapBounds[1][0] - this.mapBounds[0][0]));\n    const mapHeight = (s * (this.mapBounds[1][1] - this.mapBounds[0][1]));\n\n    // dimensions of the viewport in which the map is shown (can be bigger or smaller than map)\n    let viewPortHeight = mapHeight * (1 + offset.top + offset.bottom);\n    let viewPortWidth = mapWidth * (1 + offset.left + offset.right);\n    const mapTopOffset = mapHeight * offset.top;\n    const mapLeftOffset = mapWidth * offset.left;\n\n    // translate projection to the middle of map\n    const t = [(mapWidth - s * (this.mapBounds[1][0] + this.mapBounds[0][0])) / 2, (mapHeight - s * (this.mapBounds[1][1] + this.mapBounds[0][1])) / 2];\n\n    this.projection\n      .scale(s)\n      .translate(t);\n\n    this.mapGraph\n      .selectAll(\"path\").attr(\"d\", this.mapPath);\n\n    // handle scale to fit case\n    let widthScale, heightScale;\n    if (!this.model.ui.map.preserveAspectRatio) {\n\n      // wrap viewBox around viewport so map scales to fit viewport\n      const viewBoxHeight = viewPortHeight;\n      const viewBoxWidth = viewPortWidth;\n\n      // viewport is complete area (apart from scaling)\n      viewPortHeight = this.height * this.model.ui.map.scale;\n      viewPortWidth = this.width * this.model.ui.map.scale;\n\n      this.mapSvg\n        .attr(\"preserveAspectRatio\", \"none\")\n        .attr(\"viewBox\", [0, 0, viewBoxWidth, viewBoxHeight].join(\" \"));\n\n      //            ratio between map, viewport and offset (for bubbles)\n      widthScale = viewPortWidth / (mapWidth || 1) / (1 + offset.left + offset.right);\n      heightScale = viewPortHeight / (mapHeight || 1) / (1 + offset.top + offset.bottom);\n\n    } else {\n\n      // no scaling needed\n      widthScale = 1;\n      heightScale = 1;\n\n    }\n\n    // internal offset against parent container (mapSvg)\n    this.mapGraph\n      .attr(\"transform\", \"translate(\" + mapLeftOffset + \",\" + mapTopOffset + \")\");\n\n    // resize and put in center\n    this.mapSvg\n      .style(\"transform\", \"translate3d(\" + (margin.left + (this.width - viewPortWidth) / 2) + \"px,\" + (margin.top + (this.height - viewPortHeight) / 2) + \"px,0)\")\n      .attr(\"width\", viewPortWidth)\n      .attr(\"height\", viewPortHeight);\n\n    // set skew function used for bubbles in chart\n    const _this = this;\n    this.skew = (function() {\n      const w = _this.width;\n      const h = _this.height;\n      //input pixel loc after projection, return pixel loc after skew;\n      return function(points) {\n        //      input       scale         translate                    translate offset\n        const x = points[0] * widthScale + ((w - viewPortWidth) / 2) + mapLeftOffset * widthScale;\n        const y = points[1] * heightScale + ((h - viewPortHeight) / 2) + mapTopOffset * heightScale;\n        return [x, y];\n      };\n    })();\n\n\n  },\n\n  updateMarkerSizeLimits() {\n    const _this = this;\n    const extent = this.model.marker.size.extent || [0, 1];\n\n    if (!this.activeProfile) return utils.warn(\"updateMarkerSizeLimits() is called before ready(). This can happen if events get unfrozen and getFrame() still didn't return data\");\n\n    let minRadius = this.activeProfile.minRadiusPx;\n    let maxRadius = this.activeProfile.maxRadiusPx;\n\n    let minArea = utils.radiusToArea(Math.max(maxRadius * extent[0], minRadius));\n    let maxArea = utils.radiusToArea(Math.max(maxRadius * extent[1], minRadius));\n\n    let range = minArea === maxArea ? [minArea, maxArea] :\n      d3.range(minArea, maxArea, (maxArea - minArea) / this.sScale.domain().length).concat(maxArea);\n\n    this.sScale.range(range);\n  },\n\n  _interact() {\n    const _this = this;\n\n    return {\n      _mouseover(d, i) {\n        if (_this.model.time.dragging) return;\n\n        _this.model.marker.highlightMarker(d);\n\n        _this.hovered = d;\n        //put the exact value in the size title\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n\n        if (_this.model.marker.isSelected(d)) { // if selected, not show hover tooltip\n          _this._setTooltip();\n        } else {\n          //position tooltip\n          _this._setTooltip(d);\n        }\n      },\n      _mouseout(d, i) {\n        if (_this.model.time.dragging) return;\n        _this._setTooltip();\n        _this.hovered = null;\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n        _this.model.marker.clearHighlighted();\n      },\n      _click(d, i) {\n        _this.model.marker.selectMarker(d);\n      }\n    };\n\n  },\n\n  _blinkSuperHighlighted() {\n    this.entityBubbles\n      .classed(\"vzb-super-highlighted\", d => this.model.marker.isSuperHighlighted(d));\n  },\n\n  highlightMarkers() {\n    const _this = this;\n    this.someHighlighted = (this.model.marker.highlight.length > 0);\n\n    if (utils.isTouchDevice()) {\n      if (this.someHighlighted) {\n        _this.hovered = this.model.marker.highlight[0];\n      } else {\n        _this.hovered = null;\n      }\n      _this.updateTitleNumbers();\n      _this.fitSizeOfTitles();\n    }\n\n\n//      if (!this.selectList || !this.someSelected) return;\n//      this.selectList.classed(\"vzb-highlight\", function (d) {\n//          return _this.model.entities.isHighlighted(d);\n//      });\n//      this.selectList.each(function (d, i) {\n//        d3.select(this).selectAll(\".vzb-bmc-label-x\")\n//          .classed(\"vzb-invisible\", function(n) {\n//            return !_this.model.entities.isHighlighted(d);\n//          });\n//\n//      });\n\n  },\n\n  _updateLabel(d, index, valueX, valueY, valueS, valueC, valueL, duration) {\n    const _this = this;\n    const KEY = this.KEY;\n    if (d[KEY] == _this.druging) return;\n    if (duration == null) duration = _this.duration;\n\n    // only for selected entities\n    if (_this.model.marker.isSelected(d)) {\n\n      const showhide = d.hidden !== d.hidden_1;\n      const valueLST = null;\n      const cache = {};\n      cache.labelX0 = valueX / this.width;\n      cache.labelY0 = valueY / this.height;\n      cache.scaledS0 = valueS ? utils.areaToRadius(_this.sScale(valueS)) : null;\n      cache.scaledC0 = valueC != null ? _this.cScale(valueC) : _this.COLOR_WHITEISH;\n\n      this._labels.updateLabel(d, index, cache, valueX / this.width, valueY / this.height, valueS, valueC, valueL, valueLST, duration, showhide);\n    }\n  },\n\n  selectMarkers() {\n    const _this = this;\n    const KEY = this.KEY;\n    this.someSelected = (this.model.marker.select.length > 0);\n\n//      this._selectlist.rebuild();\n    if (utils.isTouchDevice()) {\n      _this._labels.showCloseCross(null, false);\n      if (_this.someHighlighted) {\n        _this.model.marker.clearHighlighted();\n      } else {\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n      }\n    } else {\n      // hide recent hover tooltip\n      if (!_this.hovered || _this.model.marker.isSelected(_this.hovered)) {\n        _this._setTooltip();\n      }\n    }\n\n    this.nonSelectedOpacityZero = false;\n  },\n\n  _setTooltip(d) {\n    if (d) {\n      const KEY = this.KEY;\n      const values = this.values;\n      const labelValues = {};\n      const tooltipCache = {};\n      const mouse = d3.mouse(this.graph.node()).map(d => parseInt(d));\n      const x = d.cLoc[0] || mouse[0];\n      const y = d.cLoc[1] || mouse[1];\n      const offset = d.r || 0;\n\n      labelValues.valueS = values.size[d[KEY]];\n      labelValues.labelText = labelValues.valueL = values.label[d[KEY]];\n      tooltipCache.labelX0 = labelValues.valueX = x / this.width;\n      tooltipCache.labelY0 = labelValues.valueY = y / this.height;\n      tooltipCache.scaledS0 = offset;\n      tooltipCache.scaledC0 = null;\n\n      this._labels.setTooltip(d, labelValues.labelText, tooltipCache, labelValues);\n    } else {\n      this._labels.setTooltip();\n    }\n  },\n\n  preload() {\n    const _this = this;\n\n    //this component shall fetch the preload geoshape information from a file\n    const loadFromFile = function(assetName, onSuccess) {\n      _this.model.data.getAsset(assetName, function(response){\n        _this.topology = response;\n        onSuccess();\n      });\n    }\n\n    //where the path to preload geoshape can be defined either directly in config:\n    const topoPath = utils.getProp(this, [\"model\", \"ui\", \"map\", \"topology\", \"path\"]);\n\n    //or via an entity property in dataset:\n    const topoWhich = utils.getProp(this, [\"model\", \"ui\", \"map\", \"topology\", \"which\"]);\n    const topoKey = utils.getProp(this, [\"model\", \"ui\", \"map\", \"topology\", \"key\"]);\n\n\n    return new Promise((resolve, reject) => {\n\n      // priority 1: direct URL to the topojson file\n      if (topoPath) {\n        loadFromFile(topoPath, resolve);\n\n        // priority 2: getting URL to the topojson file via DDF request\n      } else if (topoWhich) {\n        const KEY = this.model.entities.dim;\n\n        //build a query to the reader to fetch preload info\n        const query = {\n          language: this.model.locale.id,\n          from: \"entities\",\n          select: {\n            key: [KEY],\n            value: [topoWhich]\n          },\n          where: {\n            $and: [\n              { [KEY]: \"$\" + KEY }\n            ]\n          },\n          join: {\n            [\"$\" + KEY]: { key: KEY, where: { [KEY]: { $in: [topoKey || \"world\"] } } }\n          },\n        };\n\n        const dataPromise = this.model.data.load(query, { [topoWhich]: d => d });\n\n        dataPromise.then(\n          function(dataId) {\n            loadFromFile(_this.model.data.getData(dataId)[0][topoWhich], resolve);\n          },\n          err => utils.warn(\"Problem with Preload query: \", err, JSON.stringify(query))\n        );\n\n        // priority 3: no clues provided, go for a hardcoded filename for a world map\n      } else {\n        loadFromFile(\"assets/world-50m.json\", resolve);\n      }\n\n    });\n  }\n\n\n});\n\n\nexport default BubbleMapComponent;\n\n\n\n// WEBPACK FOOTER //\n// ./src/component.js","module.exports = \"<!-- Bubble Map Chart Component -->\\n<div class=\\\"vzb-bubblemap\\\">\\n    <svg class=\\\"vzb-bmc-map-background vzb-export\\\">\\n        <g class=\\\"vzb-bmc-map-graph\\\"></g>\\n    </svg>\\n    <svg class=\\\"vzb-bubblemap-svg vzb-export\\\">\\n        <g class=\\\"vzb-bmc-graph\\\">\\n            <g class=\\\"vzb-bmc-year\\\"></g>\\n\\n            <g class=\\\"vzb-bmc-lines\\\"></g>\\n            <g class=\\\"vzb-bmc-bubbles\\\"></g>\\n            <g class=\\\"vzb-bmc-bubble-labels\\\"></g>\\n\\n\\n            <g class=\\\"vzb-bmc-axis-y-title\\\">\\n                <text></text>\\n            </g>\\n\\n            <g class=\\\"vzb-bmc-axis-c-title\\\">\\n                <text></text>\\n            </g>\\n\\n            <g class=\\\"vzb-bmc-axis-y-info vzb-noexport\\\">\\n            </g>\\n\\n            <g class=\\\"vzb-bmc-axis-c-info vzb-noexport\\\">\\n            </g>\\n\\n            <g class=\\\"vzb-data-warning vzb-noexport\\\">\\n                <svg></svg>\\n                <text></text>\\n            </g>\\n            <g class=\\\"vzb-bmc-labels\\\"></g>\\n        </g>\\n    </svg>\\n</div>\\n\";\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/template.html\n// module id = 3\n// module chunks = 0"],"sourceRoot":""}